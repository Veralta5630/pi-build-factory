name: Bake Julia Engine
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    env:
      # Multi-target string: Base ARMv8 + Raspberry Pi 3/4/5 optimizations
      JULIA_CPU_TARGET: "generic;cortex-a53" 

    steps:
      - uses: actions/checkout@v4

      - name: Set up Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'

      - name: Check Target Environment
        run: |
          echo "--- TARGET DIAGNOSTICS ---"
          echo "Requested Target: $JULIA_CPU_TARGET"
          echo "Runner Processor Info:"
          lscpu | grep "Model name"
          echo "Supported LLVM Targets for this Julia Build:"
          # This lists exactly what LLVM recognizes so you can catch typos early
          julia -C help 2>&1 | grep -A 20 "Available CPUs" | head -n 25
          echo "--------------------------"

      - name: Install and Compile
        run: |
          # 1. Install packages (Julia will start precompiling for the runner host here)
          julia -e 'using Pkg; Pkg.add(["PythonCall", "DelayDiffEq", "PackageCompiler"])'
          
          # 2. NUKE THE CACHE:
          # This deletes the Neoverse-optimized files generated in the step above.
          # Without this, PackageCompiler will "steal" the host-optimized code.
          rm -rf ~/.julia/compiled/v1.10
          
          # 3. Build the Sysimage from scratch using our Raspberry Pi target
          julia -e '
            using PackageCompiler; 
            create_sysimage(["PythonCall", "DelayDiffEq"]; 
                            sysimage_path="dde_engine.so", 
                            cpu_target="generic;cortex-a53", 
                            incremental=false)'

      - name: Verify Architecture (The Final Check)
        run: |
          # The binary should NOT contain references to the runner's Neoverse chip
          if strings dde_engine.so | grep -qi "neoverse"; then
            echo "ERROR: Neoverse instructions detected! The build is tainted."
            exit 1
          else
            echo "SUCCESS: Image is clean and Pi-compatible (cortex-a53)."
          fi

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: dde_engine_arm64
          path: dde_engine.so