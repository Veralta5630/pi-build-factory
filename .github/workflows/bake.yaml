name: Bake Julia Engine
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    # This force-feeds the target to Julia's brain to use Pi-compatible architecture
    env:
      JULIA_CPU_TARGET: "cortex-a53" 

    steps:
      - uses: actions/checkout@v4

      - name: Set up Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'

      - name: Install and Compile
        run: |
          julia -e 'using Pkg; Pkg.add(["PythonCall", "DelayDiffEq", "PackageCompiler"])'
          julia -e '
            using PackageCompiler; 
            create_sysimage(["PythonCall", "DelayDiffEq"]; 
                            sysimage_path="dde_engine.so", 
                            cpu_target="cortex-a53", 
                            incremental=false)'

      - name: Verify Architecture (The Final Check)
        run: |
          if strings dde_engine.so | grep -q "neoverse-n2" && ! strings dde_engine.so | grep -q "cortex-a53"; then
            echo "STILL TAINTED! Found Neoverse."
            exit 1
          else
            echo "CLEAN! Cortex-A53 target found."
          fi

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: dde_engine_arm64
          path: dde_engine.so