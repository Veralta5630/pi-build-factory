name: Bake Julia Engine
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    env:
      # We use a multi-target string: base ARMv8 (generic) + Pi 3/4/5 (cortex-a53)
      JULIA_CPU_TARGET: "generic;cortex-a53" 

    steps:
      - uses: actions/checkout@v4

      - name: Set up Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'

      - name: Check Target Environment
        run: |
          echo "Intended Julia CPU Target: $JULIA_CPU_TARGET"
          echo "Host Runner Hardware Info:"
          lscpu | grep "Model name"
          julia -e 'using Dates; println("Build started at: ", now())'

      - name: Install and Compile
        run: |
          # 1. Install necessary packages
          julia -e 'using Pkg; Pkg.add(["PythonCall", "DelayDiffEq", "PackageCompiler"])'
          
          # 2. NUKE THE CACHE: This is critical.
          # It deletes any host-optimized (Neoverse) precompiled files created by Pkg.add
          rm -rf ~/.julia/compiled/v1.10
          
          # 3. Build the Sysimage from scratch for the Pi target
          julia -e '
            using PackageCompiler; 
            create_sysimage(["PythonCall", "DelayDiffEq"]; 
                            sysimage_path="dde_engine.so", 
                            cpu_target="generic;cortex-a53", 
                            incremental=false)'

      - name: Verify Architecture (The Final Check)
        run: |
          # Check if the binary contains Neoverse strings. 
          # If it does, we failed to isolate the build.
          if strings dde_engine.so | grep -qi "neoverse"; then
            echo "❌ STILL TAINTED! Found Neoverse instructions in the image."
            exit 1
          else
            echo "✅ CLEAN! Image contains generic/cortex-a53 instructions."
          fi

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: dde_engine_arm64
          path: dde_engine.so